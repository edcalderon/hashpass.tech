version: 1.0
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 22.18.0
        - npm install --quiet --global @expo/cli
        - >
          if [ -f yarn.lock ]; then
            yarn install --frozen-lockfile
          elif [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install
          fi
    build:
      commands:
        # Build Expo web in server mode
        - npx expo export -p web

        # Prepare Amplify deploy directory
        - mkdir -p dist/client

        # Copy static and server files to Amplify deploy folder
        - cp -r .expo/output/static/* dist/client/ || echo "No static folder found"
        - cp -r .expo/output/server/* dist/client/ || echo "No server folder found"

        # Optional: generate service worker (only if workbox-config.js exists)
        - npx workbox-cli generateSW workbox-config.js || echo "Skipping Workbox"
  artifacts:
    baseDirectory: dist/client
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - $(npm root --global)/**/*

customHeaders:
  - pattern: '**/*.js'
    headers:
      - key: Cache-Control
        value: 'public, max-age=31536000, immutable'
  - pattern: '**/*.css'
    headers:
      - key: Cache-Control
        value: 'public, max-age=31536000, immutable'
  - pattern: '**/*.html'
    headers:
      - key: Cache-Control
        value: 'public, max-age=0, must-revalidate'
  - pattern: '_expo/static/**/*'
    headers:
      - key: Cache-Control
        value: 'public, max-age=31536000, immutable'

redirects:
  # Client-side routing (SPA)
  - source: '/<*>'
    status: 200
    target: '/'
